### Contractor Compliance API

This application serves as the back-end of the Contractor Compliance API. It is written in PHP using the Laravel framework.

#### Authentication

Authentication requires an access token generated by Laravel Passport. See Authentication routes for user actions and login flow. 

#### Services

- Laravel Passport (Authentication/Oauth)
- Laravel Cashier (Billing/Stripe)

#### Build

Run `npm run setup` to setup the backend.

**OR** run `composer install`, `php artisan key:gen`, `php artisan migrate`, `php artisan passport:install`, and `php artisan db:seed` to install the application and build the database. Ensure you've created an .env file (example included) that points to a valid database, as well as includes stripe keys.

Cache and queue should use Redis drivers. Can use "file" if redis is not available

#### Tests

##### Postman 
Run `npm test` to run Postman collection. In the .env file, you can specify an environment file from `/postman/{}_ENV.json`. 

### Development Environments

Recommend Laravel Homestead vagrant machine to run the application. This will come with a database, redis and nginx server. the .env.example file will contain the proper variables to run in a homestead machine

### Server Envrionments

Laravel Forge will provision servers that are properly configured to run this applaction, included a database, redis and nginx server.

### File Storage

Files can be stored using the `public`, `local` or `s3` drivers. If using S3, most files will be stored as "private", and models will return temporary URLs to access the files as needed. To use S3, valid access and secret keys must be provided in the .env file. 

### Localization

Must localization must be handled with the client. The API, however, will localize specific requests as follows:

* 422 validation errors
* Failed authenticated messages
* Requirement attachments and descriptions

##### Backend generated friendly-error messaging

Most messaging is expected to be handled (and translated) by the client. In a few cases, a translated message will be generated and returned by the back-end. 

These cases include:

- 422 errors (validation). Validation messages will be delivered in the form of:
```$xslt
'errors' => [

    'field_name' => [
        'message'
    ]

]
```

- 402 errors (payment required). 402 errors are also translated. Usually related to payment or plan inefficiencies. This also includes 'access_level' deficiencies - while the error is of a different type, the functionality of the response is the same (read only states). The format looks like:
```$xslt
    'message' => 'message_text'
``` 

NOTE: In the future, these messages may adapt two more data-points. `action` and `action_label` to facilitate a button or link to rectify the situation (a link to the subscription page for example)

- 202 "successes". These messages are to make a user aware that while they are still getting a valid response, there may be actions or amendments needed.


### Notifications

The backend may notify the client via socket channel in some instances. These instances include: New Tasks, New Messages. These will be broadcast over Laravel Echo. 
To subscribe to these notifications, the client must: connect to the socket server (details will be documented after implementation), as well as call an authentication route when logging in (the authentication route will subscribe a user to their own notifications)

### Stripe Webhooks

Two Stripe webhooks need to be configured in production/staging environments. 

- `/api/stripe/webhook` is the main route for Laravel webhooks. Send the following stripe webhooks to this route: `customer.updated`, `customer.subscription.updated`, `customer.subscription.deleted`, `customer.source.deleted`, `customer.deleted`.
- `/api/stripe/custom-webhook` is the route stripe should contract call the subroutine to post metadata for a specific contractor. This subroutine is also called when creating a contractor.
